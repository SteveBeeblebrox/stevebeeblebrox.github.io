//See assets/js/vfs.js for license info.
var FileFlags;!function(e){e[e.READ=1]="READ",e[e.WRITE=2]="WRITE",e[e.EXECUTE=4]="EXECUTE"}(FileFlags||(FileFlags={}));class VFS{constructor(e=new ArrayMap,t=""){this.fs=e,this.HOME=t,this.SEPARATOR="/",this.PWD=this.SEPARATOR,this.OLDPWD=this.SEPARATOR,this.HOME||(this.HOME=this.SEPARATOR),this.HOME!==this.SEPARATOR&&this.mkdir("~",!0)}static escapeRegex(e){return e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}splitfp(e){return Array.isArray(e)?e:e.split(new RegExp(String.raw`(?<!^)${VFS.escapeRegex(this.SEPARATOR)}|(?<=^${VFS.escapeRegex(this.SEPARATOR)})`,"g"))}touch(e){var t;const s=this.resolveAs(e,"touch",["file","undefined"]),i=null!==(t=this.fs.get(s))&&void 0!==t?t:{dateCreated:+new Date,flags:3,contents:null};i.dateModified=+new Date,this.fs.set(s,i)}rm(e){this.fs.delete(this.resolveAs(e,"remove",["file"]))}mkdir(e,t=!1,s=!1){t?this.resolve(e).forEach((e,t,s)=>{const i=this.resolveAs(s.slice(0,t+1),"make directory",["directory","undefined"]);"undefined"===this.typeOfResolved(i)&&this.fs.init(i)}):s?this.typeOf(e):this.fs.init(this.resolveAs(e,"make directory",["undefined"]))}rmdir(e){this.fs.delete(this.resolveAs(e,"remove directory",["directory"]))}cd(e){this.resolveAs(e,"navigate to directory",["directory"],!0),[this.OLDPWD,this.PWD]=[this.PWD,this.toAbsolutePath(e)]}fname(e){return[...this.resolve(e)].pop()}mv(e,t){const s=this.resolveAs(e,"move from",["directory","file"]);let i=this.resolveAs(t,"move to",["directory","undefined"],!0);"directory"===this.typeOfResolved(i)?i=this.resolveAs([this.SEPARATOR,...i,this.fname(s)],"move to",["undefined",this.typeOfResolved(s)]):this.isResolvedRoot(i)&&(i=this.resolveAs([this.SEPARATOR,this.fname(s)],"move to",["undefined",this.typeOfResolved(s)])),this.fs.set(i,this.fs.get(s)),this.fs.delete(s)}cp(e,t){const s=this.resolveAs(e,"copy from",["directory","file"]),i=this.resolveAs(t,"copy to",["undefined",this.typeOfResolved(s)]);"directory"===this.typeOfResolved(s)?this.fs.set(i,VFS.deserialize(new VFS(this.fs.get(s),this.SEPARATOR).serialize()).fs):this.fs.set(i,JSON.parse(JSON.stringify(this.fs.get(s))))}pwd(){return this.PWD}oldpwd(){return this.OLDPWD}write(e,t){const s=this.fs.get(this.resolveAs(e,"write to file",["file"]));s.contents=t,s.dateModified=+new Date}cat(e){return this.fs.get(this.resolveAs(e,"read file",["file"])).contents}typeOf(e){return this.typeOfResolved(this.resolve(e))}ls(e=this.PWD,t=!1,s=!1){let i,r=[...this.getOptionallyRoot(i=this.resolveAs(e,"list",["directory"],!0)).keys()];return t||(r=r.filter(e=>!e[0].startsWith("."))),s?r.map(e=>"directory"===this.typeOfResolved(e)?this.ls(e,t,s):this.toAbsolutePath(this.isResolvedRoot(i)?[this.SEPARATOR,...e]:[...i,...e])).flat():r.map(e=>this.toAbsolutePath(this.isResolvedRoot(i)?[this.SEPARATOR,...e]:[this.SEPARATOR,...i,...e]))}resolveAs(e,t,s,i=!1){const r=this.resolve(e),o=this.typeOfResolved(r);if(this.isResolvedRoot(r)&&i)return r;if(!s.some(e=>e===o))throw new Error(`Could not ${null!=t?t:"access"} "${r}", it is ${"undefined"!==o?"a ":""}${o}`);return r}isResolvedRoot(e){return 1===e.length&&""===e[0]}getOptionallyRoot(e){return this.isResolvedRoot(e)?this.fs:this.fs.get(e)}checkFileFlagResolved(e,t){if(!(this.fs.get(e).flags&FileFlags[t.toUpperCase()]))throw new Error(`Missing permission "${t} (${FileFlags[t.toUpperCase()]}) for ${e}"`)}typeOfResolved(e){try{const t=this.fs.get(e,!1);return void 0===t?"undefined":t instanceof ArrayMap?"directory":"file"}catch(e){throw new Error(`Could not find directory "${e}"`)}}resolve(e){const t=this.toAbsolutePath(e).replace(new RegExp(String.raw`^${VFS.escapeRegex(this.SEPARATOR)}|${VFS.escapeRegex(this.SEPARATOR)}$`,"g"),"").split(this.SEPARATOR);if(t.length)return t;throw new Error(`Computed path for "${e}" cannot be resolved.`)}chmod(e,...t){var s;const i=this.fs.get(this.resolveAs(e,"chmod",["file"])),r=Object.assign(Object.create(null),{r:"read",w:"write",e:"execute"});for(const e of t){const t=FileFlags[(null!==(s=r[e.substring(1)])&&void 0!==s?s:e.substring(1)).toUpperCase()];"+"===e.charAt(0)?i.flags|=t:"-"===e.charAt(0)&&(i.flags&=7&~t)}}toAbsolutePath(e){let t=this.splitfp(this.PWD);return this.splitfp(e).forEach((e,s)=>{switch(e){case this.SEPARATOR:t=[this.SEPARATOR];break;case"..":t.splice(s-1,1);break;case".":break;default:0===s&&"~"===e?t=this.splitfp(this.HOME):t.push(e)}}),t.join(this.SEPARATOR).replace(new RegExp(`^${VFS.escapeRegex(this.SEPARATOR)}(?=${VFS.escapeRegex(this.SEPARATOR)})`),"")}serialize(){return JSON.stringify({fs:JSON.stringify(this.fs,function(e,t){return t instanceof ArrayMap?Object.fromEntries([...t.entries()].map(([e,t])=>[e,t instanceof ArrayMap?t:JSON.stringify(t)])):t}),home:this.HOME})}static deserialize(e){const{fs:t,home:s}=JSON.parse(e);return new VFS(JSON.parse(t,function(e,t){return"object"==typeof t&&null!==t?new ArrayMap(new Map(Object.entries(t))):JSON.parse(t)}),s)}static load(e){const t=null!==globalThis.localStorage.getItem(e)?VFS.deserialize(LZWCompression.unzip(globalThis.localStorage.getItem(e))):new VFS;return t.saveKey=e,t}save(e=this.saveKey){if(!e)throw new Error("Unable to save, no key found");globalThis.localStorage.setItem(null!=e?e:this.saveKey,LZWCompression.zip(this.serialize()))}}