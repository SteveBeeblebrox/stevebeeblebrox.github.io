class Sandbox{constructor(e){this.iframe=e,this.functions=new Map,this.uuid=window.crypto.randomUUID(),this.actions=new Map(Object.entries({callFunction({fname:e,args:t}){return this.functions.get(e)(...t)}})),e.srcdoc=`<!DOCTYPE html><html><head><script>new ${Sandbox.SandboxClient}("${window.location.origin}", "${this.uuid}");<\/script></head></html>`;const t=this;window.addEventListener("message",this.listener=async function(n){if(n.source!==e.contentWindow||n.data.uuid!==t.uuid)return;let r,a,o=!0;try{if(!t.actions.has(n.data.action))throw new Error(`(Internal Sandbox Error) Unable to trigger unknown action "${n.data.action}"`);r=t.actions.get(n.data.action).bind(t)(n.data.data)}catch(e){a=e,o=!1}try{n.ports[0].postMessage({value:await t.awaitPromise(r),error:a,ok:o})}catch(e){r=void 0,a=new Error("(Internal Sandbox Error) Unable to serialize evaluated value (The value must be supported by the structured clone algorithm)"),o=!1,n.ports[0].postMessage({value:r,error:a,ok:o})}})}static create(){const e=Object.assign(document.createElement("iframe"),{sandbox:"allow-scripts",style:"display: none;"});document.body.append(e);const t=new Sandbox(e);return new Promise((n=>e.addEventListener("load",(()=>n(t)),{once:!0})))}dispose(){this.iframe.remove(),window.removeEventListener("message",this.listener)}eval(e,t=!1){return this.triggerAction("eval",{text:e,voidResult:t})}postMessage(e){if(null===this.iframe.contentWindow)throw new Error("(Internal Sandbox Error) Sandbox has been disposed");const{port1:t,port2:n}=new MessageChannel,r=new Promise((function(e,n){t.onmessage=function(t){const{value:r,error:a,ok:o}=t.data;o?e(r):n(a)},t.onmessageerror=function(e){n(new Error("(Internal Sandbox Error) Unable to deserialize evaluated value"))}}));try{this.iframe.contentWindow.postMessage(e,"*",[n])}catch(e){throw new Error("(Internal Sandbox Error) Unable to serialize value to transfer (The value must be supported by the structured clone algorithm)")}return r}async awaitPromise(e){return e instanceof Promise?this.awaitPromise(await e):e}triggerAction(e,t){return this.postMessage({action:e,data:t,uuid:this.uuid})}invoke(e,...t){return this.triggerAction("invoke",{name:e,args:t})}get(e){return this.triggerAction("get",{name:e})}set(e,t){return this.triggerAction("set",{name:e,value:t})}setFunction(e,t){const n=t||e.name;if(!n)throw new Error("(Internal Sandbox Error) Unable to create unamed function.");this.functions.set(n,e),this.triggerAction("setFunction",{fname:n})}use(e){return this.triggerAction("use",{src:e})}}Sandbox.SandboxClient=class{constructor(e,t){this.origin=e,this.uuid=t,this.parent=null,this.actions=new Map(Object.entries({eval({text:e,voidResult:t}){const n=(0,eval)(e);return t?void 0:n},invoke:({name:e,args:t})=>Reflect.get(window,e)(...t),get:({name:e})=>Reflect.get(window,e),set:({name:e,value:t})=>Reflect.set(window,e,t),setFunction({fname:e}){const t=this;return Reflect.set(globalThis,e,(function(){return t.triggerAction("callFunction",{fname:e,args:[...arguments]})}))},use:({src:e})=>new Promise((function(t,n){document.head.append(Object.assign(document.createElement("script"),{src:e,onload(){t()},onerror(e){var t;n(new Error(`(Internal Sandbox Error) Failed to load '${null===(t=null==e?void 0:e.target)||void 0===t?void 0:t.src}'`))}}))}))}));const n=this;window.addEventListener("message",(async function(t){var r;if(t.origin!==e||t.data.uuid!==n.uuid)return;null!==(r=n.parent)&&void 0!==r||(n.parent=t.source);let a,o,i=!0;try{if(!n.actions.has(t.data.action))throw new Error(`(Internal Sandbox Error) Unable to trigger unknown action "${t.data.action}"`);a=n.actions.get(t.data.action).bind(n)(t.data.data)}catch(e){o=e,i=!1}try{t.ports[0].postMessage({value:await n.awaitPromise(a),error:o,ok:i})}catch(e){a=void 0,o=new Error("(Internal Sandbox Error) Unable to serialize evaluated value (The value must be supported by the structured clone algorithm)"),i=!1,t.ports[0].postMessage({value:a,error:o,ok:i})}}))}async awaitPromise(e){return e instanceof Promise?this.awaitPromise(await e):e}triggerAction(e,t){return this.postMessage({action:e,data:t,uuid:this.uuid})}postMessage(e){if(null===this.parent)throw new Error("(Internal Sandbox Error) No parent scope found");const{port1:t,port2:n}=new MessageChannel,r=new Promise((function(e,n){t.onmessage=function(t){const{value:r,error:a,ok:o}=t.data;o?e(r):n(a)},t.onmessageerror=function(e){n(new Error("(Internal Sandbox Error) Unable to deserialize evaluated value"))}}));try{this.parent.postMessage(e,"*",[n])}catch(e){throw new Error("(Internal Sandbox Error) Unable to serialize value to transfer (The value must be supported by the structured clone algorithm)")}return r}};